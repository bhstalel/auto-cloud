---

- name: Including docker
  inlcude_tasks: "{{autocloud_dir}}/roles/docker/tasks/main.yml"

- name: checking office directory
  stat:
    path: /usr/share/nginx/office
  register: office_check

- name: Making office directory
  file:
    path: sudo /usr/share/nginx/office
    state: directory 
  when: office_check.stat.exists == false

- name: Setting permissions
  file:
    dest: /usr/share/nginx/office
    owner: www-data
    group: www-data
    recurse: yes

- name: Setting up nginx conf file
  template:
    src: "{{autocloud_dir}}/roles/o-c/templates/collabora.conf.tpl"
    dest: "/etc/nginx/conf.d/{{collabora_domain}}.conf"
  become: yes

- name: Creating SSL
  command: sudo certbot --nginx --agree-tos --redirect --hsts --staple-ocsp --email {{email}} -d {{collabora_domain}}
  become: yes

- name: Retarting nginx
  service:
    name: nginx
    state: restarted
  become: yes

- name: install collabora app
  shell: sudo -u www-data php occ app:install richdocuments
  args:
    chdir: /var/www/nextcloud/
    creates: /var/www/nextcloud/apps/richdocuments
  notify: restart collabora container

- name: enable collabora app
  shell: sudo -u www-data php occ app:enable richdocuments
  args:
    chdir: /var/www/nextcloud/

- name: set collabora wopi url
  shell: sudo -u www-data php occ config:app:set richdocuments wopi_url --value https://{{ collabora_domain }}:443
  args:
    chdir: /var/www/nextcloud/
  notify: restart collabora container

- name: pull collabora image
  docker_image:
    name: collabora/code
    
- name: start a collabora container
  docker_container:
    name: collabora_online
    image: collabora/code
    state: started
    restart: yes
    restart_policy: always
    tty: yes
    ports:
     - "127.0.0.1:9980:9980"
    env:
        domain: "{{ nextcloud_domain | regex_replace('\\.', '\\.') }}"
    capabilities: MKNOD
  notify: restart collabora container
